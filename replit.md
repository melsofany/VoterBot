# بوت تيليجرام لجمع بيانات الناخبين - حملة علاء سليمان الحديوي

## نظرة عامة
هذا المشروع عبارة عن بوت تيليجرام ذكي مبني على إطار Mastra لجمع وإدارة بيانات الناخبين بطريقة منظمة وآلية. يستخدم البوت الذكاء الاصطناعي لتوجيه عملية جمع البيانات من المناديب.

## المميزات الرئيسية

### 🤖 بوت تيليجرام الذكي
- استقبال صور بطاقات الناخبين من المناديب
- استخراج البيانات تلقائياً باستخدام Google Cloud Vision OCR
- طلب البيانات الإضافية (اسم العائلة، رقم الهاتف، الموقع، الموقف السياسي)
- التحقق من صحة رقم الهاتف (11 رقم يبدأ بـ 01)
- نظام أذونات للتحكم في من يستطيع استخدام البوت

### 📊 لوحة تحكم متقدمة (Dashboard)
- **تسجيل دخول آمن** باستخدام username و password
- **إدارة المناديب**: إضافة وحذف المناديب مع User ID واسمهم
- **بيانات الناخبين**: عرض فوري لجميع بيانات الناخبين مع صور البطاقات
- **إحصائيات شاملة**: 
  - عدد المناديب والناخبين
  - إحصائيات الموقف (مؤيد/معارض/محايد)
  - أداء كل مندوب (عدد الناخبين المسجلين)
- **تحديث تلقائي** للبيانات كل 30 ثانية

### 🗄️ التخزين والإدارة
- حفظ كل البيانات في **Google Sheets**
- رفع صور البطاقات على **Google Drive** مع تسمية كل صورة بالرقم القومي
- قاعدة بيانات PostgreSQL لذاكرة المحادثات

## البنية التقنية

### الأدوات المستخدمة
- **Frontend/Bot**: Mastra Framework (Node.js/TypeScript)
- **AI**: OpenAI GPT-4
- **OCR**: Google Cloud Vision API
- **Storage**: Google Sheets & Google Drive
- **Database**: PostgreSQL (Neon)
- **Workflows**: Inngest
- **Messaging**: Telegraf

### مكونات المشروع

#### 1. الوكيل الذكي (Agent)
**ملف**: `src/mastra/agents/voterDataAgent.ts`
- يدير المحادثة مع المناديب
- يستخدم أدوات متخصصة لجمع البيانات
- يتحدث العربية ويوجه المناديب خطوة بخطوة

#### 2. الأدوات (Tools)
- `ocrTool.ts`: استخراج البيانات من صور البطاقات
- `uploadToDriveTool.ts`: رفع الصور على Google Drive
- `saveVoterDataTool.ts`: حفظ البيانات في Google Sheets
- `validatePhoneTool.ts`: التحقق من صحة رقم الهاتف
- `downloadTelegramPhotoTool.ts`: تحميل الصور من تيليجرام
- `sendTelegramMessageTool.ts`: إرسال الرسائل للمناديب
- `checkAuthorizedUserTool.ts`: التحقق من صلاحيات المستخدم

#### 3. سير العمل (Workflow)
**ملف**: `src/mastra/workflows/voterDataWorkflow.ts`
- استقبال رسالة تيليجرام
- معالجتها باستخدام الوكيل الذكي
- إرسال الرد للمندوب

#### 4. Dashboard API
**ملف**: `src/api/delegatesApi.ts`
- نظام تسجيل دخول آمن
- إدارة المناديب (CRUD)
- عرض بيانات الناخبين والإحصائيات

## المتغيرات البيئية المطلوبة

### إلزامية
```
TELEGRAM_BOT_TOKEN=<توكن البوت من BotFather>
GOOGLE_APPLICATION_CREDENTIALS_JSON=<ملف JSON لحساب الخدمة>
GOOGLE_SPREADSHEET_ID=<معرّف جدول Google Sheets>
```

### اختيارية
```
DASHBOARD_USERNAME=admin   # اسم المستخدم لتسجيل الدخول للوحة التحكم
DASHBOARD_PASSWORD=admin123  # كلمة المرور
OPENAI_API_KEY=<مفتاح OpenAI>  # لعمل الوكيل الذكي
```

## هيكل Google Sheets المطلوب

**✨ الإعداد التلقائي متوفر الآن!**

بدلاً من الإعداد اليدوي، يمكنك:
1. إنشاء جدول Google Sheets فارغ
2. تسجيل الدخول للوحة التحكم
3. الذهاب إلى تبويب "⚙️ إعداد النظام"
4. الضغط على "🚀 إعداد الصفحات الآن"

سيتم إنشاء الصفحات تلقائياً بالهيكل التالي:

### صفحة "المناديب"
| العمود A | العمود B |
|----------|----------|
| User ID  | الاسم    |

### صفحة "بيانات_الناخبين"
| A | B | C | D | E | F | G | H | I | J |
|---|---|---|---|---|---|---|---|---|---|
| التاريخ | الرقم القومي | اسم العائلة | رقم الهاتف | الموقف | خط العرض | خط الطول | رابط البطاقة | نص OCR | User ID المندوب |

**ملاحظة:** إذا كانت الصفحات موجودة، لن يتم إنشاؤها مرة أخرى.

## سير عمل البوت

1. **المندوب يرسل صورة البطاقة** → البوت يستخرج البيانات بـ OCR
2. **البوت يرفع الصورة** على Google Drive باسم الرقم القومي  
3. **البوت يطلب مشاركة الموقع** من المندوب
4. **البوت يطلب اسم العائلة**
5. **البوت يطلب رقم الهاتف** (يتحقق: 11 رقم يبدأ بـ 01)
6. **البوت يعرض أزرار**: مؤيد / معارض / محايد
7. **البوت يحفظ كل البيانات** في Google Sheets مع User ID المندوب

## كيفية الإعداد

### 1. إعداد Google Cloud
1. إنشاء مشروع جديد في Google Cloud Console
2. تفعيل الخدمات التالية:
   - Google Sheets API
   - Google Drive API
   - Google Cloud Vision API
3. إنشاء Service Account وتحميل ملف المفاتيح JSON
4. منح Service Account صلاحيات الوصول للجدول والمجلد

### 2. إعداد بوت تيليجرام
1. التحدث مع [@BotFather](https://t.me/BotFather)
2. إنشاء بوت جديد بالأمر `/newbot`
3. نسخ التوكن وإضافته للمتغيرات البيئية
4. ربط Webhook:
```bash
curl -X POST "https://api.telegram.org/bot<YOUR_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://YOUR_REPLIT_URL/api/webhooks/telegram/action"}'
```

### 3. إضافة المناديب
- استخدام Dashboard على `/dashboard`
- تسجيل الدخول (admin/admin123 افتراضياً)
- إضافة User IDs للمناديب المصرح لهم

## الوصول للوحة التحكم

رابط Dashboard: `https://YOUR_REPLIT_URL/dashboard`

**بيانات الدخول الافتراضية:**
- Username: `admin`
- Password: `admin123`

⚠️ **مهم**: غيّر بيانات الدخول الافتراضية عبر المتغيرات البيئية!

## التغييرات الأخيرة (أكتوبر 2025)

### ✨ جديد - 23 أكتوبر 2025:
- **إعداد تلقائي لـ Google Sheets**: 
  - تبويب جديد "⚙️ إعداد النظام" في Dashboard
  - زر لإنشاء صفحات Google Sheets تلقائياً بالهيكل الصحيح
  - لا حاجة للإعداد اليدوي للصفحات بعد الآن!
  - يتحقق النظام من الصفحات الموجودة ولا يكررها
- **إصلاح**: تحديث اسم المتغير البيئي إلى `GOOGLE_SERVICE_ACCOUNT_JSON`

### ✅ تم إضافة سابقاً:
- نظام تسجيل دخول للوحة التحكم
- إضافة حقل "الاسم" للمناديب
- صفحة عرض بيانات الناخبين مع الصور
- إحصائيات شاملة للمناديب
- تحديث تلقائي للبيانات كل 30 ثانية

### 🔧 تم تحديث:
- API endpoints لدعم المصادقة
- Google Sheets يخزن الآن User ID مع اسم المندوب
- Dashboard يعرض إحصائيات حية ومفصلة

## ملاحظات الأمان

- جميع API endpoints محمية بنظام المصادقة
- الجلسات تنتهي بعد 24 ساعة
- تأكد من تغيير username و password الافتراضيين
- لا تشارك ملفات JSON أو توكنات البوت أبداً
- راجع قانون حماية البيانات قبل جمع بيانات شخصية

## التواصل والدعم

للمساعدة أو الأسئلة، تواصل مع فريق التطوير.

---

**آخر تحديث**: 23 أكتوبر 2025
**الإصدار**: 2.1.0 - إعداد تلقائي لـ Google Sheets
